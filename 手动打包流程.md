# 手动打包流程

## 1. 适用范围

本流程适用于当前项目：

- 根目录：`f:\Desktop\qproject\demo\notice-app` ，调整成你clone到的本地目录
- WPF 项目：`NoticeApp.Wpf\NoticeApp.Wpf.csproj`
- 目标：生成单文件、可直接运行的 Windows `exe`

---

## 2. 前置要求

1. 已安装 .NET 8 SDK（`dotnet --version` 可用）
2. 使用 PowerShell 执行命令
3. 打包前先关闭正在运行的程序（尤其是旧版 `NoticeApp.Wpf.exe`）

---

## 3. 图标替换（软件图标 + 打包 EXE 图标）

如果你要使用自己的图片做图标，按下面步骤执行。

### 3.1 准备原图

将原图放到：

- `NoticeApp.Wpf\图标.png`

### 3.2 生成图标资源

在项目根目录执行（会自动生成 `icon-bell.png` 和 `app.ico`）：

```powershell
Copy-Item -LiteralPath 'NoticeApp.Wpf/图标.png' -Destination 'NoticeApp.Wpf/Assets/_user_icon_input.png' -Force
@'
from pathlib import Path
from PIL import Image

assets = Path(r'f:/Desktop/qproject/demo/notice-app/NoticeApp.Wpf/Assets')
src = assets / '_user_icon_input.png'
img = Image.open(src).convert('RGBA')

w, h = img.size
side = max(w, h)
bg = img.getpixel((0, 0))
square = Image.new('RGBA', (side, side), bg)
square.alpha_composite(img, ((side - w) // 2, (side - h) // 2))

master = assets / 'icon-master-userstyle.png'
png = assets / 'icon-bell.png'
ico = assets / 'app.ico'

square.resize((1024, 1024), Image.Resampling.LANCZOS).save(master, format='PNG')
icon512 = square.resize((512, 512), Image.Resampling.LANCZOS)
icon512.save(png, format='PNG')
icon512.save(ico, format='ICO', sizes=[(16,16),(24,24),(32,32),(48,48),(64,64),(128,128),(256,256)])
print('ok')
'@ | python -
Remove-Item 'NoticeApp.Wpf/Assets/_user_icon_input.png' -ErrorAction SilentlyContinue
```

### 3.3 说明

当前项目已在 `NoticeApp.Wpf.csproj` 配置：

```xml
<ApplicationIcon>Assets\app.ico</ApplicationIcon>
```

所以 `app.ico` 会自动作为打包后 EXE 图标。

---

## 4. 常规打包（单文件 EXE）

在项目根目录执行：

```powershell
dotnet restore NoticeApp.Wpf/NoticeApp.Wpf.csproj -r win-x64 -nologo
dotnet publish NoticeApp.Wpf/NoticeApp.Wpf.csproj `
  -c Release `
  -r win-x64 `
  -o artifacts/publish-single `
  -p:SelfContained=true `
  -p:PublishSingleFile=true `
  -p:IncludeNativeLibrariesForSelfExtract=true `
  -p:IncludeAllContentForSelfExtract=true `
  -p:EnableCompressionInSingleFile=true `
  -p:DebugType=None `
  -p:DebugSymbols=false `
  -nologo
```

输出文件：

- `artifacts\publish-single\NoticeApp.Wpf.exe`

---

## 5. 改名打包文件（例如：沙漏时钟提醒.exe）

```powershell
Rename-Item -LiteralPath 'artifacts/publish-single/NoticeApp.Wpf.exe' -NewName '沙漏时钟提醒.exe' -Force
```

改名后文件：

- `artifacts\publish-single\沙漏时钟提醒.exe`

---

## 6. 避免“文件被占用”导致打包失败

如果报错类似：

- `The process cannot access the file ... because it is being used by another process`

可选方案：

1. 先关闭正在运行的程序，再重新 `publish`
2. 或者发布到时间戳目录，避免覆盖旧文件

```powershell
$ts = Get-Date -Format 'yyyyMMdd-HHmmss'
$out = "artifacts/publish-single-$ts"
dotnet publish NoticeApp.Wpf/NoticeApp.Wpf.csproj -c Release -r win-x64 -o $out -p:SelfContained=true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -p:EnableCompressionInSingleFile=true -p:DebugType=None -p:DebugSymbols=false -nologo
```

---

## 7. 图标看起来“没变”的处理

这是 Windows 图标缓存问题，常见处理：

1. 改一下 exe 文件名再看
2. 把 exe 复制到新目录后看
3. 重启资源管理器后再刷新

可用命令：

```powershell
taskkill /f /im explorer.exe
start explorer.exe
```

---

## 8. 一条命令打包并重命名

```powershell
dotnet restore NoticeApp.Wpf/NoticeApp.Wpf.csproj -r win-x64 -nologo; `
dotnet publish NoticeApp.Wpf/NoticeApp.Wpf.csproj -c Release -r win-x64 -o artifacts/publish-single -p:SelfContained=true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:IncludeAllContentForSelfExtract=true -p:EnableCompressionInSingleFile=true -p:DebugType=None -p:DebugSymbols=false -nologo; `
Rename-Item -LiteralPath 'artifacts/publish-single/NoticeApp.Wpf.exe' -NewName '沙漏时钟提醒.exe' -Force
```

---

## 9. 快速检查命令

```powershell
Get-ChildItem artifacts/publish-single | Select-Object Name,Length
```

确认能看到目标 exe 即可。

